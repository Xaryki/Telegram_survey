import asyncio
from aiogram import types
from utils import get_keyboard
from database import save_choices, send_notification
from database import conn, cursor
from database import bot

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
START_COMMAND = 'start'
HISTORY_COMMAND = 'history'
CLEAR_COMMAND = 'clear'
HELP_COMMAND = 'help'

handlers = {
    'start': {
        'message': "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ {name} üñê \n"
                   "–Ø —á–∞—Ç-–±–æ—Ç –∫–æ–º–ø–∞–Ω–∏–∏ ARTEX\n"
                   "–ü–æ–º–æ–≥—É –≤–∞–º —Ä–∞—Å—á—ë–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è —Å–∞–π—Ç–∞ üìù\n"
                   "–î–ª—è —ç—Ç–æ–≥–æ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–æ–ø–∫—É ‚¨áÔ∏è",
        'keyboard': [
            {'text': '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–µ–∫—Ç üßæ', 'callback_data': '-----'}
        ]
    },
    '-----': {
        'message': "–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ç–∏–ø —Å–∞–π—Ç–∞ üìù",
        'keyboard': [
            {'text': '–ú–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∏–∫ üóí', 'callback_data': '—Å–∞–π—Ç_–º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∏–∫'},
            {'text': '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω üõí', 'callback_data': '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç_–º–∞–≥–∞–∑–∏–Ω'},
            {'text': '–õ–µ–Ω–¥–∏–Ω–≥ üìÉ', 'callback_data': '–ª–µ–Ω–¥–∏–Ω–≥'},
            {'text': '–°–∞–π—Ç-–≤–∏–∑–∏—Ç–∫–∞ üìÑ', 'callback_data': '—Å–∞–π—Ç-–≤–∏–∑–∏—Ç–∫–∞'},
            {'text': '–ü–æ–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–∏–ª–∏—Å—è(-–∞—Å—å) ü§î', 'callback_data': '–ø–æ–∫–∞_–Ω–µ_–æ–ø—Ä–µ–¥–∏–ª–∏—Å—è(-–∞—Å—å)'}
        ]
    },
    '—Å–∞–π—Ç_–º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∏–∫': {
        'message': "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –≤–∞—à–µ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ : ‚¨áÔ∏è",
        'keyboard': [
            {'text': '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —É—Å–ª—É–≥–∏ ‚öñÔ∏è', 'callback_data': '—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ_—É—Å–ª—É–≥–∏'},
            {'text': '–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ üß±', 'callback_data': '—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ_—É—Å–ª—É–≥–∏'},
            {'text': '–°–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∞ ‚öôÔ∏è', 'callback_data': '—Å–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∞'},
            {'text': '–¢—É—Ä–∏–∑–º –∏ –æ—Ç–¥—ã—Ö ‚úàÔ∏è', 'callback_data': '—Ç—É—Ä–∏–∑–º_–∏_–æ—Ç–¥—ã—Ö'},
            {'text': '–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –º–µ–±–µ–ª–∏ üõ†', 'callback_data': '–∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ_–º–µ–±–µ–ª–∏'},
            {'text': '–î—Ä—É–≥–æ–µ... üì¶', 'callback_data': '–¥—Ä—É–≥–æ–µ'}
        ]
    },

    '—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ_—É—Å–ª—É–≥–∏': {
        'message': "–£ –≤–∞—Å –µ—Å—Ç—å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ ? üìÉ",
        'keyboard': [
            {'text': '–î–∞ ‚úÖ', 'callback_data': '–¥–∞'},
            {'text': '–ù–µ—Ç ‚ùå', 'callback_data': '–Ω–µ—Ç'}
        ]
    },
    '—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ_—É—Å–ª—É–≥–∏': {
        'message': "–£ –≤–∞—Å –µ—Å—Ç—å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ ? üìÉ",
        'keyboard': [
            {'text': '–î–∞ ‚úÖ', 'callback_data': '–¥–∞'},
            {'text': '–ù–µ—Ç ‚ùå', 'callback_data': '–Ω–µ—Ç'}

        ]
    },
    '—Å–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∞': {
        'message': "–£ –≤–∞—Å –µ—Å—Ç—å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ ? üìÉ",
        'keyboard': [
            {'text': '–î–∞ ‚úÖ', 'callback_data': '–¥–∞'},
            {'text': '–ù–µ—Ç ‚ùå', 'callback_data': '–Ω–µ—Ç'}
        ]
    },
    '—Ç—É—Ä–∏–∑–º_–∏_–æ—Ç–¥—ã—Ö': {
        'message': "–£ –≤–∞—Å –µ—Å—Ç—å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ ? üìÉ",
        'keyboard': [
            {'text': '–î–∞ ‚úÖ', 'callback_data': '–¥–∞'},
            {'text': '–ù–µ—Ç ‚ùå', 'callback_data': '–Ω–µ—Ç'}
        ]
    },
    '–∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ_–º–µ–±–µ–ª–∏': {
        'message': "–£ –≤–∞—Å –µ—Å—Ç—å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ ? üìÉ",
        'keyboard': [
            {'text': '–î–∞ ‚úÖ', 'callback_data': '–¥–∞'},
            {'text': '–ù–µ—Ç ‚ùå', 'callback_data': '–Ω–µ—Ç'}
        ]
    },
    '–¥—Ä—É–≥–æ–µ': {
        'message': "–£ –≤–∞—Å –µ—Å—Ç—å –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ ? üìÉ",
        'keyboard': [
            {'text': '–î–∞ ‚úÖ', 'callback_data': '–¥–∞'},
            {'text': '–ù–µ—Ç ‚ùå', 'callback_data': '–Ω–µ—Ç'}
        ]
    },
    "–¥–∞": {
        "message": "–†–∞–∑–º–µ—â–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–∞ –≤–∞—à–µ–º —Å–∞–π—Ç–µ: ‚ÑπÔ∏è",
        "keyboard": [
            {"text": "–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å–ª—É–≥–∞ –ø–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é üë•", "callback_data": "—Ç—Ä–µ–±—É–µ—Ç—Å—è_—É—Å–ª—É–≥–∞_–ø–æ_—Ä–∞–∑–º–µ—â–µ–Ω–∏—é"},
            {"text": "–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ üë§", "callback_data": "—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ"}
        ]
    },
    "–Ω–µ—Ç": {
        "message": "–†–∞–∑–º–µ—â–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–∞ –≤–∞—à–µ–º —Å–∞–π—Ç–µ: ‚ÑπÔ∏è",
        "keyboard": [
            {"text": "–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å–ª—É–≥–∞ –ø–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é üë•", "callback_data": "—Ç—Ä–µ–±—É–µ—Ç—Å—è_—É—Å–ª—É–≥–∞_–ø–æ_—Ä–∞–∑–º–µ—â–µ–Ω–∏—é"},
            {"text": "–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ üë§", "callback_data": "—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ"}
        ]
    },
    "—Ç—Ä–µ–±—É–µ—Ç—Å—è_—É—Å–ª—É–≥–∞_–ø–æ_—Ä–∞–∑–º–µ—â–µ–Ω–∏—é": {
        "message": "–•–æ—Ä–æ—à–æ, –º—ã —É—á–ª–∏ –≤—Å–µ –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è üëç\n–í —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è, –æ–∂–∏–¥–∞–π—Ç–µ ! üí¨",
        "keyboard": [
            {"text": "–ë—É–¥—É –∂–¥–∞—Ç—å ! ‚è≥", "callback_data": "–æ–∂–∏–¥–∞–µ—Ç"}
        ]
    },
    "—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ": {
        "message": "–•–æ—Ä–æ—à–æ, –º—ã —É—á–ª–∏ –≤—Å–µ –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è üëç\n–í —Å–∫–æ—Ä–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è, –æ–∂–∏–¥–∞–π—Ç–µ ! üí¨",
        "keyboard": [
            {"text": "–ë—É–¥—É –∂–¥–∞—Ç—å ! ‚è≥", "callback_data": "–æ–∂–∏–¥–∞–µ—Ç"}
        ]

    },
    '–ª–µ–Ω–¥–∏–Ω–≥': {
        'message': "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –≤–∞—à–µ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ : ‚¨áÔ∏è",
        'keyboard': [
            {'text': '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —É—Å–ª—É–≥–∏ ‚öñÔ∏è', 'callback_data': '—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ_—É—Å–ª—É–≥–∏'},
            {'text': '–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ üß±', 'callback_data': '—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ_—É—Å–ª—É–≥–∏'},
            {'text': '–°–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∞ ‚öôÔ∏è', 'callback_data': '—Å–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∞'},
            {'text': '–¢—É—Ä–∏–∑–º –∏ –æ—Ç–¥—ã—Ö ‚úàÔ∏è', 'callback_data': '—Ç—É—Ä–∏–∑–º_–∏_–æ—Ç–¥—ã—Ö'},
            {'text': '–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –º–µ–±–µ–ª–∏ üõ†', 'callback_data': '–∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ_–º–µ–±–µ–ª–∏'},
            {'text': '–î—Ä—É–≥–æ–µ... üì¶', 'callback_data': '–¥—Ä—É–≥–æ–µ'}
        ]
    },

    "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç_–º–∞–≥–∞–∑–∏–Ω": {
        "message": "–í—ã –ø—Ä–æ–¥–∞–µ—Ç–µ : üè∑",
        "keyboard": [
            {"text": "–ì–æ—Ç–æ–≤—É—é –µ–¥—É üç¥", "callback_data": "–≥–æ—Ç–æ–≤—É—é_–µ–¥—É"},
            {"text": "–≠–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫—É üí°", "callback_data": "—ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫—É"},
            {"text": "–û–¥–µ–∂–¥—É –∏ –æ–±—É–≤—å üëï", "callback_data": "–æ–¥–µ–∂–¥—É_–∏_–æ–±—É–≤—å"},
            {"text": "–ú–µ–±–µ–ª—å üõè", "callback_data": "–º–µ–±–µ–ª—å"},
            {"text": "–î—Ä—É–≥–æ–µ... üì¶", "callback_data": "–¥—Ä—É–≥–æ–µ"}
        ]
    },

    "–≥–æ—Ç–æ–≤—É—é_–µ–¥—É": {
        "message": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—à–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ : üìÑ",
        "keyboard": [
            {"text": "–º–µ–Ω–µ–µ 100", "callback_data": "–º–µ–Ω–µ–µ100"},
            {"text": "–¥–æ 5000", "callback_data": "–¥–æ5000"},
            {"text": "–¥–æ 45000", "callback_data": "–¥–æ45000"},
            {"text": "–î—Ä—É–≥–æ–µ... ", "callback_data": "–¥—Ä—É–≥–æ–µ"}
        ]
    },
    "–º–µ–Ω–µ–µ100": {
        "message": "–î–ª—è –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏ –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å:",
        "keyboard": [
            {"text": "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã üõí", "callback_data": "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è_–≤_–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã"},
            {"text": "1–° –∏ ¬´–ú–æ–π —Å–∫–ª–∞–¥¬ª üì¶", "callback_data": "1–°_–∏_¬´–ú–æ–π —Å–∫–ª–∞–¥¬ª"},
            {"text": "–ù–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∏—ë–º –ª—é–±—ã—Ö –≤–∏–¥–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ —Å–∞–π—Ç üí≥",
             "callback_data": "–ü—Ä–∏–µ–º_–ø–ª–∞—Ç–µ–∂–µ–π_—Å–∞–π—Ç"}
        ]
    }
}


async def handle_callback(callback_query: types.CallbackQuery):  # –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    chat_id = callback_query.message.chat.id
    button_data = callback_query.data

    await save_choices(chat_id, button_data)

    handler = handlers.get(button_data)
    if handler:
        await bot.send_message(chat_id, handler['message'], reply_markup=await get_keyboard(handler['keyboard']))
    else:
        # –ó–∞–ø–∏—Å—å –≤—ã–±–æ—Ä–∞ –≤ –ë–î –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        user = await bot.get_chat(chat_id)
        user = user.username
        cursor.execute('''UPDATE user_choices SET user_name = ? WHERE chat_id = ?''', (user, chat_id))
        conn.commit()
        await bot.send_message(chat_id,
                               "–•–æ—Ä–æ—à–æ, –º—ã —É—á–ª–∏ –≤—Å–µ –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è.\n–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –Ω–∞—à–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ –æ–ø—Ä–æ—Å–µ!")
        asyncio.create_task(send_notification(user, chat_id))  # –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

    await bot.delete_message(chat_id, callback_query.message.message_id)


async def handle_start(message: types.Message):  # –ö–æ–º–∞–Ω–¥–∞ –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è —Å –±–æ—Ç–æ–º
    chat_id = message.chat.id
    user_name = message.from_user.first_name
    handler = handlers['start']
    await bot.send_message(chat_id, handler['message'].format(name=user_name),
                           reply_markup=await get_keyboard(handler['keyboard']))


async def handle_show_choices(message: types.Message):  # –ö–æ–º–∞–Ω–¥–∞ –ø–æ–∫–∞–∑–∞ –≤—ã–±–æ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chat_id = message.chat.id

    # –ü–æ–ª—É—á–∏—Ç—å choices –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    cursor.execute('''SELECT choices FROM user_choices WHERE chat_id = ?''',
                   (chat_id,))  # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π choice –û—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    result = cursor.fetchone()

    if result:
        choices = result[0]
        await bot.send_message(chat_id, f"–í–∞—à–∏ –≤—ã–±–æ—Ä—ã: {choices}")
    else:
        await bot.send_message(chat_id, "–í—ã –µ—â–µ –Ω–µ —Å–¥–µ–ª–∞–ª–∏ –Ω–∏–∫–∞–∫–∏—Ö –≤—ã–±–æ—Ä–æ–≤.")


async def handle_clear_choices(message: types.Message):  # –ö–æ–º–∞–Ω–¥–∞ –æ—Ç—á–∏—Å—Ç–∫–∏ –≤—ã–±–æ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chat_id = message.chat.id

    # –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ chat_id
    cursor.execute('''DELETE FROM user_choices WHERE chat_id = ?''', (chat_id,))
    conn.commit()

    await bot.send_message(chat_id, "–í–∞—à–∏ –≤—ã–±–æ—Ä—ã –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã.")


async def handle_help(message: types.Message):  # –ö–æ–º–∞–Ω–¥–∞ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
    chat_id = message.chat.id

    # –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
    commands_list = [
        f"/{START_COMMAND} - –ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –±–æ—Ç–æ–º",
        f"/{HISTORY_COMMAND} - –ü–æ–∫–∞–∑–∞—Ç—å –≤–∞—à–∏ –≤—ã–±–æ—Ä—ã",
        f"/{CLEAR_COMMAND} - –û—á–∏—Å—Ç–∏—Ç—å –≤–∞—à–∏ –≤—ã–±–æ—Ä—ã",
        f"/{HELP_COMMAND} - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥"
        # –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
    ]

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    response = "\n".join(commands_list)
    await bot.send_message(chat_id, response)
